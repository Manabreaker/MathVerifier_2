{% extends "base.html" %}
{% block content %}
<h2>–ß–∞—Ç —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é</h2>

<!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
<div class="settings-toggle" id="settings-toggle">
    <i>‚öôÔ∏è</i>
</div>

<!-- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
<div class="settings-panel" id="settings-panel">
    <div class="settings-header">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <button class="close-settings" id="close-settings">&times;</button>
    </div>
    
    <div class="settings-group">
        <h4>–ú–æ–¥–µ–ª—å</h4>
        <div class="setting-item">
            <label for="model-select">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å:</label>
            <select id="model-select">
                <option value="gpt-4o-mini">OpenAI GPT 4o-mini</option>
                <option value="gpt-4o">OpenAI GPT 4o</option>
                <option value="o1">OpenAI o1</option>
                <option value="o3-mini">OpenAI o3-mini</option>
                <option value="DeepSeek-R1">DeepSeek R1</option>
                <option value="DeepSeek-V3">DeepSeek V3</option>
                <option value="Llama-3.3-70B-Instruct">Meta Llama 3.3</option>
                <option value="Llama-3.2-90B-Vision-Instruct">Meta Llama 3.2</option>
                <option value="Meta-Llama-3.1-405B-Instruct">Meta Llama 3.1</option>
            </select>
        </div>
    </div>
    
    <div class="settings-group">
        <h4>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h4>
        <div class="setting-item">
            <label for="temperature-range">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: <span id="temperature-value">0.7</span></label>
            <div class="range-input">
                <input type="range" id="temperature-range" min="0" max="1" step="0.1" value="0.7">
            </div>
        </div>
    </div>
    
    <div class="settings-group">
        <h4>–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h4>
        <div class="setting-item">
            <label for="theme-select">–¢–µ–º–∞:</label>
            <select id="theme-select">
                <option value="dark">–¢—ë–º–Ω–∞—è</option>
                <option value="light">–°–≤–µ—Ç–ª–∞—è</option>
                <option value="system">–°–∏—Å—Ç–µ–º–Ω–∞—è</option>
            </select>
        </div>
    </div>
    
    <div class="settings-footer">
        <button class="apply-settings" id="apply-settings">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>
</div>

<div id="chat-history"></div>
<form id="chat-form">
    <div class="input-container">
        <input type="text" name="message" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" required>
        <button type="button" id="mic-button" class="mic-button"><i class="mic-icon">üéôÔ∏è</i></button>
    </div>
    <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</form>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –¥–ª—è –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞ -->
<div id="recording-indicator" class="recording-indicator">
    <div class="recording-pulse"></div>
    <span>–ì–æ–≤–æ—Ä–∏—Ç–µ...</span>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º marked.js –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º marked.js –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ LaTeX
    marked.setOptions({
        renderer: new marked.Renderer(),
        highlight: function(code, lang) {
            return code;
        },
        pedantic: false,
        gfm: true,
        breaks: true,
        sanitize: false,
        smartypants: false,
        xhtml: false
    });

    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
    const settingsToggle = document.getElementById("settings-toggle");
    const settingsPanel = document.getElementById("settings-panel");
    const closeSettings = document.getElementById("close-settings");
    const applySettings = document.getElementById("apply-settings");
    const modelSelect = document.getElementById("model-select");
    const temperatureRange = document.getElementById("temperature-range");
    const temperatureValue = document.getElementById("temperature-value");
    const themeSelect = document.getElementById("theme-select");

    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
    const micButton = document.getElementById("mic-button");
    const recordingIndicator = document.getElementById("recording-indicator");
    const messageInput = document.getElementById("message-input");

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    let chatSettings = {
        model: "gpt-4o-mini",
        temperature: 0.7,
        theme: "dark"
    };

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ localStorage –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    function loadSettings() {
        const savedSettings = localStorage.getItem("mathVerifierSettings");
        if (savedSettings) {
            chatSettings = JSON.parse(savedSettings);
            modelSelect.value = chatSettings.model;
            temperatureRange.value = chatSettings.temperature;
            temperatureValue.textContent = chatSettings.temperature;
            themeSelect.value = chatSettings.theme;
            applyTheme(chatSettings.theme);
        }
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ localStorage
    function saveSettings() {
        localStorage.setItem("mathVerifierSettings", JSON.stringify(chatSettings));
    }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É
    function applyTheme(theme) {
        const root = document.documentElement;
        if (theme === "light") {
            root.style.setProperty("--bg-primary", "#f0f0f0");
            root.style.setProperty("--bg-secondary", "#ffffff");
            root.style.setProperty("--bg-tertiary", "#e9e9e9");
            root.style.setProperty("--text-primary", "#333333");
            root.style.setProperty("--text-secondary", "#666666");
        } else {
            root.style.setProperty("--bg-primary", "#121212");
            root.style.setProperty("--bg-secondary", "#1e1e1e");
            root.style.setProperty("--bg-tertiary", "#252525");
            root.style.setProperty("--text-primary", "#ffffff");
            root.style.setProperty("--text-secondary", "#b0b0b0");
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è/—Å–∫—Ä—ã—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    function toggleMicButton() {
        if (messageInput.value.trim() === '') {
            micButton.style.display = 'flex';
        } else {
            micButton.style.display = 'none';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞
    function startVoiceRecording() {
        recordingIndicator.classList.add('active');
        
        // –í—ã–∑–æ–≤ API –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
        fetch('/api/speech-to-text', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            recordingIndicator.classList.remove('active');
            
            if (data.status === 'success' && data.text) {
                messageInput.value = data.text;
                toggleMicButton();
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É, –µ—Å–ª–∏ –±—ã–ª–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ —Ä–µ—á—å
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            } else {
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            }
        })
        .catch(error => {
            recordingIndicator.classList.remove('active');
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞: ' + error.message);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏
    function showError(message) {
        appendMessage('bot', 'Math Verifier: –û—à–∏–±–∫–∞: ' + message);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
    settingsToggle.addEventListener("click", () => {
        settingsPanel.classList.add("open");
        settingsToggle.style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
    });

    closeSettings.addEventListener("click", () => {
        settingsPanel.classList.remove("open");
        settingsToggle.style.display = "flex"; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
    });

    temperatureRange.addEventListener("input", () => {
        temperatureValue.textContent = temperatureRange.value;
    });

    applySettings.addEventListener("click", () => {
        chatSettings.model = modelSelect.value;
        chatSettings.temperature = parseFloat(temperatureRange.value);
        chatSettings.theme = themeSelect.value;
        
        saveSettings();
        applyTheme(chatSettings.theme);
        settingsPanel.classList.remove("open");
        settingsToggle.style.display = "flex"; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
    });

    // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ (–ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞)
    messageInput.addEventListener('input', toggleMicButton);

    // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    micButton.addEventListener('click', startVoiceRecording);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadSettings();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
    toggleMicButton();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
    let speechSynthesis = window.speechSynthesis;
    let currentUtterance = null;
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
    function speakText(text) {
        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –æ–∑–≤—É—á–∏–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        if (speechSynthesis.speaking) {
            speechSynthesis.cancel();
            currentUtterance = null;
            return;
        }
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ru-RU';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        
        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â–µ–µ –æ–∑–≤—É—á–∏–≤–∞–Ω–∏–µ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        currentUtterance = utterance;
        
        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –æ–∑–≤—É—á–∏–≤–∞–Ω–∏–µ
        speechSynthesis.speak(utterance);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è HTML-—Ç–µ–≥–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–µ—Ä–µ–¥ –æ–∑–≤—É—á–∏–≤–∞–Ω–∏–µ–º
    function stripHtml(html) {
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = html;
        return tempDiv.textContent || tempDiv.innerText || "";
    }
    
    const form = document.getElementById("chat-form");
    const chatHistory = document.getElementById("chat-history");

    form.addEventListener("submit", async function(e) {
        e.preventDefault();
        const userMessage = messageInput.value.trim();
        if (!userMessage) return;

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç —Å—Ä–∞–∑—É (—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π HTML)
        appendMessage("user", "–í—ã: " + escapeHtml(userMessage));
        messageInput.value = "";
        toggleMicButton(); // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        chatHistory.scrollTop = chatHistory.scrollHeight;

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–∂–∏–¥–∞–Ω–∏—è
        const loadingId = showLoading();

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º JSON-–∑–∞–ø—Ä–æ—Å —Å —É—á–µ—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫
            const response = await fetch("/api/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    messages: [
                        {
                            "role": "user",
                            "content": userMessage
                        }
                    ],
                    model: chatSettings.model,
                    temperature: chatSettings.temperature,
                })
            });

            const data = await response.json();
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            hideLoading(loadingId);

            if (response.ok) {
                // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–ª—è
                const botResponse = data.response || data.bot_message || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç";
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Markdown-–æ—Ç–≤–µ—Ç –≤ HTML —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º LaTeX
                const formattedHtml = marked.parse(botResponse);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è –∫ —Å–æ–æ–±—â–µ–Ω–∏—é –±–æ—Ç–∞
                appendMessage("bot", `<div class="bot-message-content">Math Verifier: ${formattedHtml}</div><button class="speak-button" title="–û–∑–≤—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">üîä</button>`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–∏ –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è
                const speakButtons = document.querySelectorAll('.speak-button');
                const lastSpeakButton = speakButtons[speakButtons.length - 1];
                
                lastSpeakButton.addEventListener('click', function() {
                    const messageContent = this.previousElementSibling.textContent;
                    const cleanText = stripHtml(messageContent);
                    speakText(cleanText);
                });
                
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª—ã –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏—Ö –≤ DOM
                if (window.MathJax) {
                    MathJax.typesetPromise && MathJax.typesetPromise();
                }
            } else {
                throw new Error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: " + (data.detail || response.statusText));
            }
        } catch (error) {
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            hideLoading(loadingId);
            console.error("Error:", error);
            appendMessage("bot", "Math Verifier: –û—à–∏–±–∫–∞: " + error);
        }
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –¥–æ –∫–æ–Ω—Ü–∞
        chatHistory.scrollTop = chatHistory.scrollHeight;
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    function showLoading() {
        const loadingDiv = document.createElement("div");
        loadingDiv.classList.add("message", "bot", "loading");
        loadingDiv.innerHTML = "Math Verifier: –î—É–º–∞—é...";
        chatHistory.appendChild(loadingDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
        return loadingDiv.id = "loading-" + Date.now();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    function hideLoading(id) {
        const loadingDiv = document.getElementById(id);
        if (loadingDiv) {
            loadingDiv.remove();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
    function appendMessage(sender, htmlContent) {
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message", sender);
        msgDiv.innerHTML = htmlContent;
        chatHistory.appendChild(msgDiv);
    }

    // –§—É–Ω–∫—Ü–∏—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
</script>
{% endblock %}
